# Story 2.10: Physical→Mind Navigation (Web Zoom)

## Status
Draft

## Story
**As a** user viewing the Physical map,
**I want** to click on a marker and be navigated to the Mind card view for that Abode,
**so that** I can seamlessly transition from exploring the physical world to viewing detailed Mind information.

## Acceptance Criteria
1. When user clicks a marker on the Physical map, they are navigated to the Mind card view (`/mind/[id]`) for the associated Abode
2. The navigation preserves the relationship between the physical marker and the Mind being viewed
3. The transition is smooth and intuitive (no intermediate loading screens unless necessary)
4. User can navigate back to the Physical map from the Mind card view
5. The marker click interaction is distinct from other map interactions (panning, zooming)
6. Works with all marker types displayed on the Physical map (buildings, pins, etc.)

## Tasks / Subtasks
- [ ] Update MapView component to handle marker click navigation (AC: 1, 2, 5, 6)
  - [ ] Add click event handler to markers that captures the Abode ID
  - [ ] Implement Next.js navigation to `/mind/[id]` route
  - [ ] Ensure marker click doesn't interfere with map panning/zooming
  - [ ] Test with different marker types (3D buildings, 2D pins)
- [ ] Verify Mind card view page accepts navigation from map (AC: 1, 2)
  - [ ] Confirm `/mind/[id]/page.tsx` properly receives and displays the Abode data
  - [ ] Test that navigation works for all valid Abode IDs
- [ ] Implement back navigation capability (AC: 4)
  - [ ] Add back button or browser back support in Mind card view
  - [ ] Consider adding breadcrumb or navigation context
- [ ] Ensure smooth transition experience (AC: 3)
  - [ ] Optimize loading states if needed
  - [ ] Test navigation performance
- [ ] Write comprehensive tests
  - [ ] Unit tests for marker click handler logic
  - [ ] Integration tests for map → Mind navigation flow
  - [ ] E2E test for complete user journey

## Dev Notes

### Context from Previous Stories
- **Story 2.7 (Physical Map)**: Implemented the MapView component using MapLibre GL with 3D buildings and markers. The map displays Abodes as markers on the physical map. Key components: `app/components/map/MapView.tsx`, `app/components/map/MapContainer.tsx`
- **Story 2.8 (Mind Card View)**: Created the Pokemon-style Mind card view at `/mind/[id]/page.tsx` that displays detailed Abode information in a card format. Component: `app/components/MindCard.tsx`
- **Story 2.9 (Mind List/Grid)**: Implemented list and grid views for browsing Minds at `/mind/page.tsx` with sorting and filtering

### Tech Stack (from PRD)
- **Frontend**: Next.js 14 (App Router), React 18, TypeScript
- **Mapping**: MapLibre GL JS for 2D/3D map rendering
- **Routing**: Next.js App Router with dynamic routes (`/mind/[id]`)
- **Navigation**: Next.js `useRouter` hook or `next/navigation` for programmatic navigation

### Source Tree
```
app/
├── components/
│   ├── map/
│   │   ├── MapView.tsx          # Main map component - needs marker click handling
│   │   ├── MapContainer.tsx     # Map wrapper
│   │   └── MapController.tsx    # Map controls
│   ├── MindCard.tsx             # Mind card component used in detail view
│   └── MindCardPreview.tsx      # Preview version of Mind card
├── mind/
│   ├── [id]/
│   │   └── page.tsx            # Mind detail page (destination for navigation)
│   ├── page.tsx                # Mind list/grid page
│   └── MindGridView.tsx        # Grid view component
```

### Implementation Notes
- The MapView component likely uses MapLibre GL markers or GeoJSON features for Abodes
- Marker click events in MapLibre are handled via `map.on('click', layerName, callback)`
- Each marker should have an associated Abode ID in its properties
- Use Next.js `useRouter` from `next/navigation` for programmatic navigation
- Navigation format: `router.push('/mind/' + abodeId)`
- Consider using the `router.back()` method or a custom back button in the Mind card view
- Ensure proper TypeScript typing for marker data and navigation params

### Key Integration Points
- Map markers → Abode ID extraction → Navigation to `/mind/[id]`
- Existing Mind card page should handle incoming navigation without modification
- May need to distinguish between marker clicks and map interaction clicks

### Testing
#### Test File Location
- Unit tests: `tests/components/map/map-view-navigation.test.tsx`
- Integration tests: `tests/mind/physical-mind-navigation.test.tsx`
- E2E tests: `tests/e2e/map-to-mind-flow.test.ts` (if E2E framework is set up)

#### Test Standards
- **No Flaky Tests**: Proper async handling, explicit waits for navigation completion
- **No Hard Waits**: Use dynamic strategies (waiting for URL changes, component rendering)
- **Stateless**: Tests run independently and don't depend on each other
- **Self-Cleaning**: Tests create and clean up their own test data
- **Clear Assertions**: Keep assertions in test files, not buried in helpers

#### Testing Requirements for This Story
- Mock MapLibre GL map instance and marker interactions
- Test marker click triggers navigation with correct Abode ID
- Verify navigation doesn't occur on map pan/zoom interactions
- Test that Mind card page renders correctly after navigation
- Test back navigation returns to map (or appropriate previous page)
- Test error handling for invalid Abode IDs
- Integration test covering full flow: map load → marker click → Mind page display

#### Testing Frameworks
- **Unit/Integration**: Jest + React Testing Library
- **Component Testing**: @testing-library/react with proper user event simulation
- **MapLibre Mocking**: May need to mock MapLibre GL methods and events

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-07 | 1.0 | Initial story draft created | SM Agent (Bob) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent during implementation_

### Debug Log References
_To be populated by dev agent during implementation_

### Completion Notes List
_To be populated by dev agent during implementation_

### File List
_To be populated by dev agent during implementation_

## QA Results
_To be populated by QA agent during review_
