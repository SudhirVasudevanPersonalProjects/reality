# Story 5.6: Nested Abodes & Emergent Hierarchy (ROUGH DRAFT)

## Status
**Draft**

---

## Story

**As a** user building my inner map,
**I want** to nest abodes within other abodes and see hierarchy emerge from clustering/counts,
**so that** I can build deeper abstractions like "Heart contains Beauty, Ugly, Dreams" without forced structure.

---

## Acceptance Criteria (DRAFT)

### AC1: Nested Abode Creation
- User can create an abode inside another abode
- Example: Create "Sunsets" abode inside "Beauty" abode
- Uses existing `parent_id` relationship
- Visual: Nested abodes shown as contained circles/nodes

### AC2: Abode-of-Abodes
- An abode can contain:
  - Raw somethings (captures)
  - Other abodes
  - Or both
- No limit on nesting depth
- Example hierarchy:
  ```
  Heart (abode)
    ├── Beauty (abode)
    │   ├── Sunsets (abode)
    │   │   └── sunset-photo-1.jpg
    │   └── ocean-video.mp4
    └── Ugly (abode)
        └── traffic-noise.txt
  ```

### AC3: Emergent Hierarchy from Counts
- Hierarchy is NOT forced - emerges from:
  - Number of somethings in an abode (weight)
  - Number of nested abodes
  - Frequency of use
- Visual weight: Larger abodes have more mass
- More captures through an abode = higher in visual hierarchy

### AC4: Automatic Clustering
- Somethings with same abode cluster magnetically
- Soft force-field pulls them closer (not overlapping)
- Creates "constellation" feel
- Abodes become gravity wells

### AC5: Visual Representation of Depth
- Layer depth = nesting level
- Can toggle to see different depths:
  - Depth 0: All raw somethings
  - Depth 1: First-level abodes
  - Depth 2: Abodes-of-abodes
  - etc.
- Zoom in/out reveals different abstraction levels

### AC6: Abode Merging
- User can merge two abodes that represent same concept
- Combines children
- Resolves duplicates
- Recalculates positions

### AC7: Re-parenting
- User can move something to different abode
- User can move abode to different parent
- Hierarchy recalculates automatically
- No position lock - meaning is not spatial

### AC8: Multiple Membership (Tags, not Containers)
- A something can have multiple tags (belong to multiple abodes)
- This is handled via:
  - Multiple `parent_id` entries (junction table), OR
  - Treat it as "primary" + "additional tags"
- Visual: Something appears with blended signatures

---

## Tasks / Subtasks (ROUGH)

- [ ] Add UI for creating nested abodes
- [ ] Implement hierarchy calculation algorithm
- [ ] Add clustering force simulation
- [ ] Create depth toggle/zoom visualization
- [ ] Implement abode merging
- [ ] Add re-parenting drag-and-drop
- [ ] Handle multiple membership (if needed)
- [ ] Update 2D renderer for nested visualization

---

## Dev Notes (ROUGH)

### Hierarchy Calculation

Hierarchy emerges from data, not structure:

```typescript
interface AbodeStats {
  id: string
  name: string
  depth: number           // Nesting level from root
  childCount: number      // Direct children (somethings + abodes)
  totalDescendants: number // All nested items
  weight: number          // Calculated importance
}

function calculateHierarchy(abodes: Something[]): AbodeStats[] {
  // Recursive calculation
  // Weight = childCount + sum(child weights)
}
```

### Clustering Algorithm

Use force-directed layout for same-abode clustering:

```typescript
function applyClusteringForces(somethings2D: Something2D[]) {
  // Group by parent_id
  // Apply attractive force within group
  // Apply repulsive force between groups
  // Bounded by hexagonal lattice
}
```

### Multiple Membership Problem

Current model: One `parent_id` per something.

Options for multiple membership:
1. **Junction table** - `something_abodes (something_id, abode_id)`
2. **Primary + tags** - `parent_id` is primary, separate tags array
3. **Duplicate entries** - Same something in multiple places (not clean)

Recommendation: Use junction table for clean many-to-many.

### Visual Depth Toggle

```typescript
interface DepthView {
  currentDepth: number
  showAbodes: boolean
  showSomethings: boolean
}

// Depth 0: Only raw somethings visible
// Depth 1: Abodes + their contained somethings
// Depth 2: Abodes-of-abodes + nested
```

### The "Sandwich Layers" Concept

User mentioned wanting to "sandwich layers" - insert intermediate abstractions:

```
Before:
Something → Beauty

After:
Something → Sunsets → Beauty

// Sunsets is sandwiched between
```

This is just re-parenting:
1. Create "Sunsets" abode
2. Move something to Sunsets
3. Move Sunsets to Beauty

No special mechanism needed.

---

## Dependencies

- Story 5.4: Basic tag assignment
- Story 5.5: Filter views (to see nested structure)

---

## Open Questions

1. Should we support true many-to-many (something in multiple abodes)?
2. How to visualize very deep nesting (5+ levels)?
3. Should merging be automatic (ML-suggested) or always manual?
4. Performance concerns with force simulation on large datasets?

---

## Future Extensions (Not in this story)

- AI-suggested abode groupings
- Auto-clustering based on semantic similarity
- Social sharing of abode structures
- Import/export of hierarchies

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-20 | 0.1 | Rough draft created | SM (Bob) |
