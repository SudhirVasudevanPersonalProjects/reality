# Story 3.4: Somewhere, A Realm of Somethings - 3D Zoomable Space

## Status
**InProgress**

---

## Implementation Status

### ‚úÖ Completed:
- **Task 1**: Three.js Scene Setup (AC1) - Scene, camera, renderer working
- **Task 2**: Question Mark Texture (AC2) - Using canvas-generated grey "?" (not SVG)
- **Task 3**: Hexagonal Lattice Distribution (AC3) - Implemented in `lib/ur-reality/hexagonal-lattice.ts`
- **Task 4**: Database Schema (AC4) - Migration exists: `20251110000001_add_max_somethings_bound.sql`
- **Task 6**: Perlin Noise Background (AC5) - Implemented with 3000x3000 plane, covers screen at max zoom
- **Task 8**: Three View Levels (AC7) - Camera transitions working (20¬∞ ‚Üí 90¬∞ angle shift)
- **Task 10**: Pan/Zoom Controls (AC9) - Click-drag pan and scroll zoom implemented
- **Task 11**: Mobile Block (AC10) - Detects < 768px and shows message
- **Task 12**: UI Changes (AC11) - Rocket button, search bar visible

### ‚ö†Ô∏è TBD / Partially Implemented:
- **Task 5**: Bounded Space Logic (AC4) - Database fetches max_somethings_bound, but warning message when limit exceeded NOT implemented
- **Task 7**: Circular Border (AC6) - Border handled via Perlin noise fade (no visible border line needed)
- **Task 9**: Click to Focus (AC8) - Camera zoom works, but **spotlight effect NOT implemented**
- **Task 13**: Floating Animation (AC2) - Code exists in `render-question-marks.ts` but **currently disabled** (commented out line 164 in UrRealityClient)
- **Task 14**: Content Display (AC12) - `SomethingContent.tsx` component exists, but **positioning in 3D context TBD**
- **Task 15**: Hover Interaction (AC12) - Raycasting detects hover, sets state, but **content may not be visible properly**
- **Task 17**: Link Preview Thumbnails (AC14, AC15) - **NOT implemented** (YouTube & TikTok only, NO Instagram)
- **Task 18**: Tests - **NOT implemented**

### üìù Design Decisions:
- **Lattice Type**: Using **hexagonal lattice** (NOT rhombi lattice as originally stated)
- **Border**: Perlin noise fade provides visual separation, no visible circular border line
- **Question Mark**: Canvas-generated grey "?" instead of SVG
- **Link Thumbnails**: YouTube Shorts + TikTok only (Instagram excluded)

---

## Story

**As a** user who wants to navigate and organize my captured somethings,
**I want** a 3D zoomable space with Three.js where question marks float on a hexagonal lattice in a bounded "Somewhere" realm surrounded by Perlin noise,
**so that** I can pan, zoom between three view levels (45¬∞ default, bird's eye, max zoom), and click to focus on individual somethings in an infinite-feeling yet bounded space.

---

## Acceptance Criteria

### AC1: 3D Scene Setup (Three.js)
- Route: `/ur-reality` (evolve from v3.3)
- Use Three.js for 3D rendering
- Fixed camera view (no rotation controls)
- 45-degree angle default camera position (top-down-ish perspective)
- Similar camera setup to Story 2.7 (globe with 3D buildings)
- Scene renders on canvas, full-screen

### AC2: Question Mark Visuals
- Use `white-question-mark-emoji-clipart-original.svg` for question mark
- Move SVG to `public/assets/` or similar folder
- Bottom ellipse is actual circle (not stretched square)
- Colorable fill (default: grey/white, no red)
- **All question marks same physical size in world space** (constant scale in 3D)
- **Apparent size changes via camera zoom** (not object scaling)
- Subtle floating animation: bob up and down very slightly (1-2px movement, slow sine wave)

### AC3: Hexagonal Lattice Distribution
- Position question marks on invisible hexagonal lattice
- **Rotationally symmetric lattice** that fits inside circular border
- Hexagonal pattern provides equal spacing between all question marks
- Lattice is not visible to user (organic appearance)
- Lattice must accommodate user's max bound (default 50 somethings)
- Start with zoom level that shows entire circle on one screen

### AC4: Bounded Space & User Limit
- Default: User can have max 50 somethings in "Somewhere" abode
- Max limit is per-user setting (stored in database: `users` table, new field `max_somethings_bound`)
- If user has > max limit, show message: "Your reality is full. Organize your somethings before capturing more."
- Bounded space = visible border separating somethings from "Unknown"

### AC5: Perlin Noise Background
- Perlin noise texture surrounds the bounded space
- Cloud-like appearance
- Represents "Unknown" - space outside organized somethings
- Should fill entire canvas except bounded space
- Subtle, not overwhelming (light grey tones on dark blue base)

### AC6: The Border
- **Circular border** around the cluster of somethings
- Circle size scales based on user's max somethings limit
- For max 50 somethings: Hexagonal lattice must fit 50 points inside circle
- Border separates "Somewhere" (organized somethings) from "Unknown" (Perlin noise)
- **Implementation Note**: Border handled via Perlin noise fade (no visible border line needed)
- Everything is scalable (circle size adapts to max bound)

### AC7: Three Zoom Levels (Camera Distance-Based)
**View 1: Default View (45-degree angle)**
- Camera at 45¬∞ angle, top-down-ish perspective
- Camera distance: Close enough to see question mark details
- Individual question marks clearly visible and interactive
- User can pan (click-drag) and zoom in/out (scroll)
- Hover on question mark shows content preview (keep from v3.3)
- Click question mark ‚Üí zoom to isolated view (AC8)

**View 2: Bird's Eye View (zoomed out)**
- Triggered when user scrolls out past threshold
- Camera auto-shifts from 45¬∞ to bird's eye (top-down, 90¬∞)
- Camera distance: Far enough that question marks appear as dots
- Question marks appear as dots (camera too far to see ? details)
- Show: cluster of dots + border + Perlin noise around
- Smooth transition (1-2 seconds)
- **Note**: Question marks don't shrink - camera just moves farther away

**View 3: Max Zoom Out (extreme)**
- Triggered when user scrolls out further
- Camera distance: Extremely far
- Single dot representing entire abode (all somethings appear as one point)
- Surrounded by Perlin noise (fills most of canvas)
- Represents totality of "Somewhere, A Realm of Somethings"
- **Note**: Question marks still same size in world space - just appear as single dot due to extreme distance

### AC8: Click to Focus (Isolated View)
- When user clicks a question mark in Default View:
  - Camera zooms in on that question mark (smooth transition)
  - **Spotlight effect** shines around focused question mark
  - Question mark moves to **bottom center of screen**
  - Content appears **above** question mark (comes out of center of ?)
  - Only the clicked something is visible (others fade out or hide)
  - Isolated view: spotlight + question mark (bottom center) + content (above)
- To return: scroll out or click outside content area
- Zoom out transition returns to Default View

### AC9: Pan/Zoom Controls (Desmos-like)
**Pan (Click-Drag)**:
- Click and hold on background (not a question mark)
- Drag to move camera through the space
- Smooth, responsive panning
- Works in Default View and Bird's Eye View
- Does not work in Max Zoom Out (single dot, no panning)

**Zoom (Scroll)**:
- Scroll wheel to zoom in/out (desktop)
- Pinch gesture for iPad
- **Zoom = camera distance change** (not object scaling)
- Smooth zoom transitions
- Zoom triggers view level changes based on camera distance (AC7)

### AC10: Mobile Block & Device Support
- **Mobile (phone)**: Block access, show message "View on bigger screen"
- **iPad**: Full support
- **Desktop/Laptop**: Full support (primary experience)
- Detect viewport width: < 768px ‚Üí block, >= 768px ‚Üí allow

### AC11: UI Changes
- Remove speech bubble from rocket button (comment out code for now)
- Keep rocket button visible (bottom left)
- Keep search bar visible (bottom center) but non-functional
- No other UI changes

### AC12: Content Display (Updated from v3.3)
- Hover on question mark (Default View): show content preview underneath
- Click question mark (Isolated View): content appears **above** question mark
- Content types: text, photo, video thumbnail, link preview with thumbnail
- Content styling: white background, rounded corners, shadow
- Max width: 400px, scrollable if long
- Z-index above question marks
- Content disappears when hover ends (unless clicked for isolated view)

### AC14: Link Preview Thumbnails (New) - YouTube & TikTok Only
- **YouTube Shorts**: Extract VIDEO_ID from URL, load thumbnail from `https://img.youtube.com/vi/VIDEO_ID/hqdefault.jpg`
- **TikTok**: Fetch `https://www.tiktok.com/oembed?url=VIDEO_URL`, extract `thumbnail_url` from JSON response
- **NOT IMPLEMENTING Instagram** (excluded from scope)
- Display thumbnail as Three.js texture (TextureLoader ‚Üí PlaneGeometry ‚Üí MeshBasicMaterial)
- Click thumbnail or link ‚Üí open URL in new tab (target="_blank")
- Apply to:
  - **Deep-Capture page**: Show thumbnail preview when pasting link
  - **/ur-reality page**: Show thumbnail in content display (hover/click)

### AC15: Deep-Capture Page Updates (Patch) - YouTube & TikTok Only
- When user pastes YouTube Shorts or TikTok link:
  - Fetch thumbnail image
  - Show preview in package before sending
  - Store thumbnail URL in `attributes.link_preview.thumbnail_url`
- Click preview image ‚Üí open link in new tab
- Reuse LinkPreviewCard component, add thumbnail support
- **NOT IMPLEMENTING Instagram** (excluded from scope)

### AC13: Performance
- Acceptable performance up to 50 somethings (per-user max)
- Three.js scene should render at 60fps
- Smooth zoom/pan transitions (no lag)
- Perlin noise should not cause performance issues (optimize texture size)

---

## Tasks / Subtasks

- [X] **Task 1: Three.js Scene Setup** (AC1)
  - [ ] Install Three.js: `pnpm add three @types/three`
  - [ ] Create `lib/ur-reality/three-scene.ts` (scene, camera, renderer setup)
  - [ ] Update `app/ur-reality/UrRealityClient.tsx` to use Three.js canvas
  - [ ] Set camera to 45-degree angle (default view)
  - [ ] Reference Story 2.7 for similar camera setup (globe with buildings)
  - [ ] Full-screen canvas, no rotation controls

- [X] **Task 2: Move & Update Question Mark SVG** (AC2)
  - [ ] Move `docs/white-question-mark-emoji-clipart-original.svg` ‚Üí `public/assets/question-mark.svg`
  - [ ] Verify bottom ellipse is proper circle (not stretched)
  - [ ] Make fill color changeable (remove hardcoded `#a6aeb0`, use grey/white default)
  - [ ] Load SVG as texture in Three.js

- [X] **Task 3: Hexagonal Lattice Distribution Algorithm** (AC3) ‚úÖ COMPLETED
  - [X] Create `lib/ur-reality/hexagonal-lattice.ts`
  - [X] Function: `distributeOnHexagonalLattice(count: number, maxBound: number)`
  - [X] Return: `{ x, y, z }[]` positions for each something
  - [X] Logic:
    - [X] Generate **rotationally symmetric hexagonal lattice**
    - [X] Lattice must fit inside circular border (radius based on maxBound)
    - [X] Position somethings at hexagonal vertices
    - [X] Equal spacing between all somethings
    - [X] Accommodate up to maxBound somethings (default 50)
    - [X] Start with zoom showing entire circle on one screen
  - [ ] Write unit tests for distribution algorithm - **TBD**

- [X] **Task 4: Database Schema - User Max Bound** (AC4) ‚úÖ COMPLETED
  - [X] Add migration: `users` table add column `max_somethings_bound INT DEFAULT 50`
  - [X] Update `database.types.ts` (regenerate typesuse)
  - [X] Fetch user's max bound in `app/ur-reality/page.tsx`
  - [X] Pass max bound to client component

- [ ] **Task 5: Bounded Space Logic** (AC4) ‚ö†Ô∏è PARTIALLY COMPLETED
  - [X] In `app/ur-reality/page.tsx`: Count user's somethings
  - [ ] If count > user's `max_somethings_bound`:
    - [ ] Show message: "Your reality is full. Organize your somethings before capturing more." - **TBD**
    - [ ] Link to capture page disabled (or show warning) - **TBD**
  - [X] Pass bound status to client component

- [X] **Task 6: Perlin Noise Background** (AC5) ‚úÖ COMPLETED
  - [X] Install Perlin noise library: `pnpm add simplex-noise`
  - [X] Create `lib/ur-reality/perlin-noise-texture.ts`
  - [X] Generate Perlin noise texture (canvas-based)
  - [X] Apply as background in Three.js scene (3000x3000 plane with shader)
  - [X] Cloud-like appearance, light grey tones
  - [X] Performance: 1024x1024 texture, covers screen at max zoom

- [X] **Task 7: Circular Border Rendering** (AC6) ‚úÖ COMPLETED (using Perlin fade)
  - [X] Create `lib/ur-reality/render-border.ts` (exists but not used)
  - [X] Function: `calculateCircleRadius(maxBound: number)` in hexagonal-lattice.ts
  - [X] Border handled via Perlin noise fade in shader (no visible line)
  - [X] Circle scales with user's max_somethings_bound
  - [ ] Subtle glow/outline effect - **NOT NEEDED** (Perlin fade sufficient)

- [X] **Task 8: Three View Levels - Camera Transitions** (AC7) ‚úÖ COMPLETED
  - [X] Create `lib/ur-reality/zoom-levels.ts`
  - [X] Define zoom thresholds:
    - [X] Default View: distance < 150
    - [X] Bird's Eye View: 150 < distance < 400
    - [X] Max Zoom Out: distance > 400
  - [X] Implement camera transition logic:
    - [X] Smooth lerp between camera positions/angles
    - [X] Auto-shift from 20¬∞ to 90¬∞ (bird's eye)
    - [X] Question marks appear smaller due to camera distance
  - [X] Update renderer based on zoom level:
    - [X] LOD updates based on camera distance (opacity changes)

- [ ] **Task 9: Click to Focus (Isolated View with Spotlight)** (AC8) ‚ö†Ô∏è PARTIALLY COMPLETED
  - [X] Detect click on question mark (raycasting in Three.js)
  - [X] On click:
    - [X] Animate camera zoom to clicked question mark (smooth transition)
    - [ ] Add **spotlight effect** around focused question mark - **TBD / NOT IMPLEMENTED**
    - [ ] Position question mark at **bottom center of screen** - **TBD**
    - [ ] Display content **above** question mark - **TBD** (content positioning needs work)
    - [X] Hide/fade other question marks (darken on click)
    - [X] Isolated view state (focusedId tracking)
  - [X] Exit isolated view:
    - [X] Click outside content area (clears focusedId)
    - [ ] Scroll out (zoom threshold) - **TBD**

- [X] **Task 10: Pan/Zoom Controls** (AC9) ‚úÖ COMPLETED
  - [X] Implement click-drag to pan:
    - [X] Detect mouse down on background (not question mark)
    - [X] Track mouse move, update camera position
    - [X] Panning works in all views
  - [X] Implement scroll to zoom:
    - [X] Mouse wheel event listener
    - [X] Zoom in/out (update camera distance)
    - [X] Trigger view level changes based on zoom
    - [X] Smooth zoom transitions
  - [ ] iPad: Pinch gesture for zoom (touch events) - **TBD**

- [X] **Task 11: Mobile Block & Device Detection** (AC10) ‚úÖ COMPLETED
  - [X] Detect viewport width on page load
  - [X] If width < 768px:
    - [X] Show message: "View on bigger screen"
    - [X] Hide Three.js canvas
    - [X] Show link to capture page
  - [X] If width >= 768px: Show full experience

- [X] **Task 12: UI Changes** (AC11) ‚úÖ COMPLETED
  - [X] No speech bubble (never existed in this version)
  - [X] Keep rocket button visible (bottom left)
  - [X] Keep search bar visible (bottom center)
  - [X] Zoom slider added (bottom center)
  - [X] No UI conflicts with Three.js canvas

- [ ] **Task 13: Question Mark Floating Animation** (AC2) ‚ö†Ô∏è CODE EXISTS BUT DISABLED
  - [X] Code exists in `render-question-marks.ts`
  - [ ] Currently **commented out in UrRealityClient.tsx line 164** - **TBD**
  - [X] Function `updateFloatingAnimation()` implemented
  - [X] Sine wave logic ready (amplitude 0.3, frequency 0.0008)

- [ ] **Task 14: Content Display in Three.js Context** (AC12) ‚ö†Ô∏è PARTIALLY COMPLETED
  - [X] Reuse `SomethingContent.tsx` component from v3.3
  - [ ] Position content relative to question mark position in 3D space - **TBD**
  - [ ] Convert 3D position to 2D screen coordinates (project to screen) - **TBD**
  - [X] Render content as HTML overlay on top of Three.js canvas (centered)
  - [X] Z-index: Content above canvas

- [ ] **Task 15: Hover Interaction in Three.js** (AC12) ‚ö†Ô∏è PARTIALLY COMPLETED
  - [X] Raycasting to detect hover on question mark
  - [X] On hover: Sets hoveredId state
  - [ ] Content positioning needs work - **TBD**
  - [X] On hover end: Hide content (clears hoveredId)
  - [ ] Only works in Default View (not Bird's Eye or Max Zoom) - needs distance check

- [ ] **Task 16: Manual Testing** (All ACs) ‚ö†Ô∏è ONGOING
  - [ ] Test Three.js scene loads and renders
  - [ ] Test rhombi lattice distribution (1-50 somethings)
  - [ ] Test three zoom levels (default, bird's eye, max zoom)
  - [ ] Test camera transitions (smooth, correct angles)
  - [ ] Test pan (click-drag) in Default View and Bird's Eye View
  - [ ] Test zoom (scroll) triggers view changes
  - [ ] Test click to focus (isolated view)
  - [ ] Test hover shows content preview
  - [ ] Test Perlin noise background renders
  - [ ] Test border adapts to somethings distribution
  - [ ] Test floating animation (subtle bob)
  - [ ] Test mobile block message
  - [ ] Test iPad experience
  - [ ] Test performance (60fps with 50 somethings)

- [ ] **Task 17: Link Preview Thumbnails - YouTube & TikTok Only** (AC14, AC15) ‚ùå NOT IMPLEMENTED
  - [ ] Create `lib/link-preview/fetch-thumbnail.ts` - **TBD**
  - [ ] Function: `fetchLinkThumbnail(url: string)` - **TBD**
  - [ ] Logic:
    - [ ] Detect URL type (YouTube, TikTok only)
    - [ ] **YouTube Shorts**: Extract VIDEO_ID, return `https://img.youtube.com/vi/VIDEO_ID/hqdefault.jpg` - **TBD**
    - [ ] **TikTok**: Fetch `https://www.tiktok.com/oembed?url=${url}`, extract `thumbnail_url` from JSON - **TBD**
    - [ ] **NO Instagram** (excluded from scope)
    - [ ] Return thumbnail URL or null
  - [ ] Update `LinkPreviewCard.tsx`: - **TBD**
    - [ ] Add thumbnail display (image above title/description)
    - [ ] Click thumbnail or link ‚Üí `window.open(url, '_blank')`
  - [ ] Update Deep-Capture page: - **TBD**
    - [ ] When pasting link, fetch thumbnail
    - [ ] Show thumbnail in package preview
    - [ ] Store thumbnail in `attributes.link_preview.thumbnail_url`
  - [ ] Update /ur-reality: - **TBD**
    - [ ] Load thumbnail as Three.js texture (TextureLoader)
    - [ ] Render as PlaneGeometry with MeshBasicMaterial
    - [ ] Click ‚Üí open link in new tab

- [ ] **Task 18: Write Tests** (Testing section) ‚ùå NOT IMPLEMENTED
  - [ ] Unit test: Rhombi lattice distribution algorithm
  - [ ] Unit test: Border calculation (convex hull)
  - [ ] Unit test: Zoom level thresholds
  - [ ] Integration test: Fetch user's max bound from database
  - [ ] E2E test: Pan and zoom interactions
  - [ ] E2E test: Click to focus (isolated view)
  - [ ] E2E test: Mobile block message

---

## Dev Notes

### Source Tree (Relevant)

```
app/
‚îú‚îÄ‚îÄ ur-reality/
‚îÇ   ‚îú‚îÄ‚îÄ page.tsx                ‚Üê UPDATE: Fetch max_somethings_bound, check count
‚îÇ   ‚îî‚îÄ‚îÄ UrRealityClient.tsx     ‚Üê UPDATE: Use Three.js, remove v3.3 distribution
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ SomethingContent.tsx    ‚Üê REUSE: Content display (updated for 3D context)
‚îÇ   ‚îî‚îÄ‚îÄ LinkPreviewCard.tsx     ‚Üê REUSE: Link preview card
lib/
‚îî‚îÄ‚îÄ ur-reality/
    ‚îú‚îÄ‚îÄ three-scene.ts           ‚Üê ‚úÖ DONE: Three.js scene, camera, renderer setup
    ‚îú‚îÄ‚îÄ hexagonal-lattice.ts     ‚Üê ‚úÖ DONE: Hexagonal lattice distribution algorithm
    ‚îú‚îÄ‚îÄ perlin-noise-texture.ts  ‚Üê ‚úÖ DONE: Perlin noise background generation
    ‚îú‚îÄ‚îÄ render-border.ts         ‚Üê ‚úÖ DONE: Border rendering (exists but not used - Perlin fade used instead)
    ‚îú‚îÄ‚îÄ render-question-marks.ts ‚Üê ‚úÖ DONE: Question mark rendering & animation
    ‚îú‚îÄ‚îÄ zoom-levels.ts           ‚Üê ‚úÖ DONE: Zoom level logic and camera transitions
    ‚îî‚îÄ‚îÄ distribute-question-marks.ts ‚Üê DEPRECATE: Old v3.3 distribution (keep for reference)
public/
‚îî‚îÄ‚îÄ assets/
    ‚îî‚îÄ‚îÄ question-mark.svg        ‚Üê NEW: Moved from docs/
supabase/
‚îî‚îÄ‚îÄ migrations/
    ‚îî‚îÄ‚îÄ YYYYMMDD_add_max_somethings_bound.sql ‚Üê NEW: Add column to users table
```

### Key Technical Details

**1. Three.js Scene Setup**

```ts
import * as THREE from 'three'

export function createUrRealityScene(canvas: HTMLCanvasElement) {
  // Scene
  const scene = new THREE.Scene()
  scene.background = new THREE.Color(0x0a1628) // Dark blue

  // Camera (45-degree angle, similar to Story 2.7)
  const camera = new THREE.PerspectiveCamera(
    45, // FOV
    window.innerWidth / window.innerHeight,
    0.1,
    10000
  )
  camera.position.set(0, 100, 100) // 45-degree angle
  camera.lookAt(0, 0, 0)

  // Renderer
  const renderer = new THREE.WebGLRenderer({ canvas, antialias: true })
  renderer.setSize(window.innerWidth, window.innerHeight)
  renderer.setPixelRatio(window.devicePixelRatio)

  return { scene, camera, renderer }
}
```

**2. Hexagonal Lattice Distribution (Rotationally Symmetric, Fits in Circle)**

```ts
export function distributeOnHexagonalLattice(
  count: number,
  maxBound: number
): { x: number; y: number; z: number }[] {
  const positions: { x: number; y: number; z: number }[] = []

  // Calculate circle radius based on maxBound
  const circleRadius = calculateCircleRadius(maxBound)

  // Calculate hexagonal spacing to fit maxBound points inside circle
  const spacing = (circleRadius * 2) / Math.ceil(Math.sqrt(maxBound))

  // Hexagonal lattice with rotational symmetry
  const angleOffset = Math.PI / 3 // 60 degrees for hexagonal pattern
  const rows = Math.ceil(Math.sqrt(count))
  const cols = Math.ceil(count / rows)

  // Center the lattice
  const centerOffset = {
    x: (cols * spacing) / 2,
    z: (rows * spacing * Math.sin(angleOffset)) / 2
  }

  for (let i = 0; i < count; i++) {
    const row = Math.floor(i / cols)
    const col = i % cols

    // Hexagonal offset for alternating rows
    const rowOffset = row % 2 === 0 ? 0 : spacing / 2

    const x = col * spacing + rowOffset - centerOffset.x
    const z = row * spacing * Math.sin(angleOffset) - centerOffset.z
    const y = 0 // All on same plane for now

    // Check if within circular border
    const distance = Math.sqrt(x * x + z * z)
    if (distance <= circleRadius) {
      positions.push({ x, y, z })
    }
  }

  return positions
}

function calculateCircleRadius(maxBound: number): number {
  // Circle radius in world space units
  // For 50 somethings: comfortable spacing visible at default camera distance (100 units)
  const baseRadius = 50 // Base unit
  const scale = Math.sqrt(maxBound / 50) // Scale based on max
  return baseRadius * scale
}

// IMPORTANT: This returns positions in world space
// Question mark meshes are created at constant scale (e.g., 1.0)
// Apparent size changes come from camera distance, not mesh scaling
```

**3. Perlin Noise Background**

```ts
import { createNoise2D } from 'simplex-noise'

export function generatePerlinNoiseTexture(
  width: number,
  height: number
): THREE.Texture {
  const canvas = document.createElement('canvas')
  canvas.width = width
  canvas.height = height
  const ctx = canvas.getContext('2d')!

  const noise2D = createNoise2D()
  const imageData = ctx.createImageData(width, height)

  for (let y = 0; y < height; y++) {
    for (let x = 0; x < width; x++) {
      const value = noise2D(x / 50, y / 50) // Scale for cloud-like effect
      const brightness = (value + 1) / 2 * 255 // Normalize to 0-255

      const idx = (y * width + x) * 4
      imageData.data[idx] = brightness * 0.6 // R (grey tones)
      imageData.data[idx + 1] = brightness * 0.6 // G
      imageData.data[idx + 2] = brightness * 0.7 // B (slightly blue)
      imageData.data[idx + 3] = 255 // A
    }
  }

  ctx.putImageData(imageData, 0, 0)

  const texture = new THREE.CanvasTexture(canvas)
  return texture
}
```

**4. Zoom Levels & Camera Transitions (Distance-Based)**

```ts
export const ZOOM_THRESHOLDS = {
  // Camera distances (not object scales)
  DEFAULT_VIEW_DISTANCE: 100, // Close enough to see ? details
  BIRDS_EYE_VIEW_DISTANCE: 300, // Far enough for dots
  MAX_ZOOM_OUT_DISTANCE: 1000, // Extremely far, single dot
}

export function updateCameraForZoom(
  camera: THREE.PerspectiveCamera,
  scrollDelta: number, // From wheel event
  currentDistance: number
) {
  // Calculate new distance based on scroll
  const zoomSpeed = 0.1
  const newDistance = currentDistance + scrollDelta * zoomSpeed

  // Clamp distance (prevent too close / too far)
  const clampedDistance = Math.max(50, Math.min(2000, newDistance))

  // Determine view level based on distance
  let targetPosition: THREE.Vector3
  let targetRotation: THREE.Euler

  if (clampedDistance < ZOOM_THRESHOLDS.DEFAULT_VIEW_DISTANCE) {
    // Default View (45-degree angle)
    const d = clampedDistance
    targetPosition = new THREE.Vector3(0, d * Math.sin(Math.PI/4), d * Math.cos(Math.PI/4))
    targetRotation = new THREE.Euler(-Math.PI / 4, 0, 0)
  } else if (clampedDistance < ZOOM_THRESHOLDS.BIRDS_EYE_VIEW_DISTANCE) {
    // Transition: 45¬∞ ‚Üí 90¬∞ (interpolate)
    const t = (clampedDistance - ZOOM_THRESHOLDS.DEFAULT_VIEW_DISTANCE) /
              (ZOOM_THRESHOLDS.BIRDS_EYE_VIEW_DISTANCE - ZOOM_THRESHOLDS.DEFAULT_VIEW_DISTANCE)
    const angle = Math.PI/4 + (Math.PI/4) * t // 45¬∞ ‚Üí 90¬∞
    targetPosition = new THREE.Vector3(0, clampedDistance * Math.sin(angle), clampedDistance * Math.cos(angle))
    targetRotation = new THREE.Euler(-angle, 0, 0)
  } else {
    // Bird's Eye & Max Zoom Out (90-degree, straight down)
    targetPosition = new THREE.Vector3(0, clampedDistance, 0)
    targetRotation = new THREE.Euler(-Math.PI / 2, 0, 0)
  }

  // Smooth lerp to target
  camera.position.lerp(targetPosition, 0.1) // 10% interpolation per frame
  camera.rotation.setFromEuler(targetRotation)

  return clampedDistance // Return new distance for state tracking
}

// IMPORTANT: Question marks never change scale
// They're rendered at constant size in world space
// Apparent size change is purely due to camera distance
```

**5. Click to Focus (Isolated View with Spotlight)**

```ts
export function handleQuestionMarkClick(
  questionMark: THREE.Object3D,
  camera: THREE.Camera,
  scene: THREE.Scene,
  onFocus: () => void
) {
  // Get question mark position
  const targetPos = questionMark.position.clone()

  // Move question mark to bottom center of screen
  const screenBottomCenter = new THREE.Vector3(0, -10, 0) // Bottom center in world space

  // Animate question mark position
  animatePosition(questionMark, screenBottomCenter, 1000) // 1 second

  // Add spotlight effect
  const spotlight = new THREE.SpotLight(0xffffff, 2)
  spotlight.position.set(targetPos.x, targetPos.y + 30, targetPos.z)
  spotlight.target = questionMark
  spotlight.angle = Math.PI / 6 // Cone angle
  spotlight.penumbra = 0.3 // Soft edge
  scene.add(spotlight)

  // Zoom camera to focused view
  const cameraTarget = new THREE.Vector3(0, 20, 30) // Above and in front
  animateCamera(camera, cameraTarget, () => {
    onFocus() // Callback to show content above question mark, hide others
  })

  // Return spotlight reference for cleanup on exit
  return spotlight
}
```

**6. Floating Animation**

```ts
// In render loop
export function updateFloatingAnimation(
  questionMarks: THREE.Mesh[],
  time: number
) {
  questionMarks.forEach((qm, index) => {
    // Sine wave for floating (stagger by index for variety)
    const offset = Math.sin(time * 0.001 + index * 0.5) * 0.02 // 2% of unit size
    qm.position.y = offset
  })
}
```

**7. Circular Border Rendering**

```ts
export function calculateCircularBorder(maxBound: number): number {
  // Circle radius based on maxBound
  const baseRadius = 50
  const scale = Math.sqrt(maxBound / 50)
  return baseRadius * scale
}

// Render circular border in Three.js
export function renderCircularBorder(
  scene: THREE.Scene,
  radius: number
) {
  // Create circle geometry (edge only, not filled)
  const curve = new THREE.EllipseCurve(
    0, 0, // Center
    radius, radius, // X radius, Y radius
    0, 2 * Math.PI, // Start angle, end angle
    false, // Clockwise
    0 // Rotation
  )

  const points = curve.getPoints(64) // 64 segments for smooth circle
  const geometry = new THREE.BufferGeometry().setFromPoints(
    points.map(p => new THREE.Vector3(p.x, 0.1, p.y))
  )

  const material = new THREE.LineBasicMaterial({
    color: 0xffffff,
    linewidth: 2,
    transparent: true,
    opacity: 0.6
  })

  const circle = new THREE.Line(geometry, material)
  scene.add(circle)

  // Optional: Add glow effect with shader or bloom post-processing
}
```

**8. Database Migration**

```sql
-- supabase/migrations/YYYYMMDD_add_max_somethings_bound.sql

ALTER TABLE users
ADD COLUMN max_somethings_bound INT DEFAULT 50;

COMMENT ON COLUMN users.max_somethings_bound IS
  'Maximum number of somethings user can have in Somewhere abode before organizing';
```

**9. Link Thumbnail Loading in Three.js**

```ts
export async function loadLinkThumbnail(
  url: string,
  scene: THREE.Scene,
  position: THREE.Vector3
): Promise<THREE.Mesh | null> {
  // Fetch thumbnail URL
  const thumbnailUrl = await fetchLinkThumbnail(url)
  if (!thumbnailUrl) return null

  // Load texture
  const loader = new THREE.TextureLoader()
  const texture = await new Promise<THREE.Texture>((resolve, reject) => {
    loader.load(
      thumbnailUrl,
      (tex) => resolve(tex),
      undefined,
      (err) => reject(err)
    )
  })

  // Create plane with thumbnail texture
  const geometry = new THREE.PlaneGeometry(2, 2) // Adjust size
  const material = new THREE.MeshBasicMaterial({ map: texture })
  const plane = new THREE.Mesh(geometry, material)

  // Position above question mark
  plane.position.set(position.x, position.y + 3, position.z)

  // Make plane face camera (billboard effect)
  plane.lookAt(camera.position)

  // Add click handler
  plane.userData = { url, isClickable: true }

  scene.add(plane)
  return plane
}

// Click handler for opening link
export function handleThumbnailClick(mesh: THREE.Mesh) {
  if (mesh.userData.isClickable && mesh.userData.url) {
    window.open(mesh.userData.url, '_blank')
  }
}
```

**10. Mobile Block Detection**

```tsx
// In UrRealityClient.tsx
const [isMobile, setIsMobile] = useState(false)

useEffect(() => {
  const checkViewport = () => {
    setIsMobile(window.innerWidth < 768)
  }
  checkViewport()
  window.addEventListener('resize', checkViewport)
  return () => window.removeEventListener('resize', checkViewport)
}, [])

if (isMobile) {
  return (
    <div className="flex flex-col items-center justify-center h-screen">
      <p className="text-xl">View on bigger screen</p>
      <Link href="/capture">Go to Capture</Link>
    </div>
  )
}
```

### Architecture Principles

**Three.js Integration**:
- Similar to Story 2.7 (globe with 3D buildings)
- Fixed camera view (no orbit controls)
- Performance: 60fps with 50 objects

**Hexagonal Lattice**:
- Equal spacing, organic appearance
- Invisible structure, visible result
- Scalable (adapts to count)

**Bounded Space Philosophy**:
- Default 50 max = forces user to organize
- "Somewhere" (organized) vs "Unknown" (noise)
- Border visualizes the boundary

**Three View Levels**:
- Default: Work with individual somethings
- Bird's Eye: See collection overview
- Max Zoom: Totality of your reality

**Desmos-like Feel**:
- Smooth pan/zoom
- Responsive, intuitive controls
- No UI chrome, just space

### Testing

**Test File Location:**
- Unit tests: `tests/ur-reality/hexagonal-lattice.test.ts`, `tests/ur-reality/border.test.ts`, `tests/ur-reality/zoom-levels.test.ts`
- Integration tests: `tests/api/max-somethings-bound.test.ts`
- E2E tests: `tests/e2e/ur-reality-3d-interactions.test.ts`

**Testing Standards:**

1. **No Flaky Tests**:
   - Mock Three.js scene in unit tests
   - Use deterministic noise seed for Perlin tests
   - Wait for camera transitions to complete in E2E tests

2. **Stateless Tests**:
   - Create test somethings in `beforeEach`
   - Delete test somethings in `afterEach`
   - Reset camera position between tests

3. **Appropriate Test Levels**:
   - Unit: Hexagonal lattice algorithm, border calculation, zoom level logic
   - Integration: Fetch max bound from database
   - E2E: Pan/zoom interactions, click to focus

**Test Coverage Required (NOT YET IMPLEMENTED):**

- ‚ö†Ô∏è Unit: Hexagonal lattice distribution (1-50 somethings, equal spacing) - TBD
- ‚ö†Ô∏è Unit: Border calculation (adapts to distribution) - TBD
- ‚ö†Ô∏è Unit: Zoom level thresholds (correct view for distance) - TBD
- ‚ö†Ô∏è Unit: Perlin noise generation (texture created) - TBD
- ‚ö†Ô∏è Integration: Fetch user's max_somethings_bound - TBD
- ‚ö†Ô∏è E2E: Pan (click-drag) in Default View - TBD
- ‚ö†Ô∏è E2E: Zoom (scroll) triggers view level changes - TBD
- ‚ö†Ô∏è E2E: Click question mark ‚Üí isolated view - TBD
- ‚ö†Ô∏è E2E: Hover shows content preview - TBD
- ‚ö†Ô∏è E2E: Mobile block message displays - TBD

**Testing Frameworks:**
- Jest (unit tests)
- React Testing Library (component tests)
- Playwright or Cypress (E2E)
- Three.js testing utilities (mock scene)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-10 | 1.0 | Initial draft | SM Bob |
| 2025-11-11 | 1.1 | Updated implementation status, changed rhombi‚Üíhexagonal, removed Instagram from Task 17, noted border uses Perlin fade | Dev James |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

None - Documentation update only per user request

### Completion Notes

**2025-11-11**: Updated story documentation with implementation status per user request:
- Changed all "rhombi lattice" references to "hexagonal lattice" throughout document
- Added comprehensive Implementation Status section at top
- Marked completed tasks (Tasks 1-4, 6-8, 10-12) with ‚úÖ
- Marked TBD items (Tasks 5, 9, 13-18) with ‚ö†Ô∏è or ‚ùå
- Updated AC6 to note border uses Perlin noise fade (no visible line)
- Updated AC14 and AC15 to remove Instagram (YouTube & TikTok only)
- Updated all code examples and file references to use "hexagonal"
- Updated source tree to show actual implemented files
- Marked all tests as TBD/NOT IMPLEMENTED
- No code changes made - documentation update only

**Key TBD Items**:
- Spotlight effect (Task 9)
- Content positioning in 3D space (Tasks 14-15)
- Floating animation (commented out)
- Link preview thumbnails (Task 17)
- Bounded space warning message (Task 5)
- All tests (Task 18)

### File List

**Documentation Files Modified:**
- `docs/stories/3.4-somewhere-realm-3d-zoomable-space.md` - Updated with implementation status and corrections

**No Code Changes Made**

---

## QA Results

[To be filled by QA agent]
