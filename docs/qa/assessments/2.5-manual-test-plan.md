# Manual Test Plan: Story 2.5 - Physical Location Capture & Geocoding

**Story ID**: 2.5
**Story Title**: Physical Location Capture & Geocoding
**Test Plan Version**: 1.0
**Created**: 2025-11-05
**Test Architect**: Quinn

---

## Test Objective

Validate that users can search for locations using Mapbox autocomplete, capture precise geographic coordinates, and successfully save Physical somethings with mappable data for the 3D reality map.

---

## Scope

### In Scope
- Mapbox autocomplete integration and UI behavior
- Location search functionality with dropdown suggestions
- Coordinate capture (latitude, longitude, formatted_address)
- Database storage and validation of coordinates
- Manual entry fallback with warning messages
- Keyboard navigation and accessibility
- Error handling for API failures
- Physical vs Mind realm coordinate requirements

### Out of Scope
- 3D map rendering (Story 2.7)
- LLM-enhanced location search (Epic 4)
- Edit/geocode existing locations (future enhancement)

---

## Prerequisites

### Environment Setup
1. **Mapbox Token**: Verify `NEXT_PUBLIC_MAPBOX_TOKEN` is configured in `.env.local`
2. **Database**: Migration `20251105000001_add_location_fields.sql` applied successfully
3. **Dependencies**: `@mapbox/mapbox-sdk` and TypeScript types installed
4. **Application**: Development server running (`pnpm dev`)
5. **Test Data**: At least one capture in "I captured this" list

### Test User Account
- Valid authenticated user with at least 1 unorganized capture

### Tools Required
- Chrome DevTools (Network tab for API monitoring)
- Keyboard for accessibility testing
- Screen reader (optional, for WCAG validation)

---

## Test Cases

### **TC-01: Mapbox Autocomplete Integration**

**Priority**: P0 (Critical)
**AC Reference**: AC 1, 2, 3

**Objective**: Verify autocomplete shows location suggestions from Mapbox

**Preconditions**:
- User is on Chamber page (`/chamber`)
- At least one capture exists in "I captured this" list

**Test Steps**:
1. Click on a capture card to expand organization panel
2. Select "Physical" realm radio button
3. Type "La Jolla" into location input field (wait 300ms for debounce)
4. Observe dropdown suggestions appear

**Expected Results**:
- ✅ Loading indicator appears briefly while fetching
- ✅ Dropdown shows up to 5 suggestions from Mapbox
- ✅ Each suggestion displays place name and formatted address
- ✅ Suggestions are relevant to query (e.g., "La Jolla, California", "La Jolla Cove")
- ✅ Network tab shows successful Mapbox API call

**Pass/Fail**: Pass
**Notes**: ___________________________________________

---

### **TC-02: Location Selection & Coordinate Capture**

**Priority**: P0 (Critical)
**AC Reference**: AC 4, 5

**Objective**: Verify selecting a suggestion captures latitude, longitude, and formatted address

**Preconditions**:
- TC-01 passed (dropdown with suggestions visible)

**Test Steps**:
1. Click on first suggestion in dropdown (e.g., "La Jolla, California")
2. Observe input field updates with selected place name
3. Observe dropdown closes
4. Click "Organize" button (with care level 1-5 selected)
5. Open Chrome DevTools → Network tab
6. Inspect POST request to `/api/somethings/[id]/organize`

**Expected Results**:
- ✅ Input field shows selected place name
- ✅ Dropdown closes on selection
- ✅ POST request body includes:
  - `latitude`: number (e.g., 32.8328)
  - `longitude`: number (e.g., -117.2713)
  - `location_name`: string (e.g., "La Jolla, California")
  - `formatted_address`: string (e.g., "La Jolla, San Diego County, California, United States")
- ✅ API response is 200 OK
- ✅ Capture moves to appropriate care level container

**Pass/Fail**: ______
**Notes**: ___________________________________________

---

### **TC-03: Database Coordinate Storage**

**Priority**: P0 (Critical)
**AC Reference**: AC 5

**Objective**: Verify coordinates are saved to database correctly

**Preconditions**:
- TC-02 passed (Physical something organized with coordinates)

**Test Steps**:
1. Open Supabase Studio or run SQL query:
   ```sql
   SELECT id, location_name, latitude, longitude, formatted_address, visited, realm
   FROM somethings
   WHERE realm = 'physical'
   ORDER BY organized_at DESC
   LIMIT 1;
   ```
2. Verify the most recently organized something has coordinate data

**Expected Results**:
- ✅ `latitude` is populated (decimal, e.g., 32.8328)
- ✅ `longitude` is populated (decimal, e.g., -117.2713)
- ✅ `formatted_address` is populated (string)
- ✅ `location_name` matches selected place
- ✅ `visited` is `true`
- ✅ `realm` is `'physical'`

**Pass/Fail**: ______
**Notes**: ___________________________________________

---

### **TC-04: Coordinate Range Validation (Invalid Latitude)**

**Priority**: P0 (Critical)
**AC Reference**: AC 6

**Objective**: Verify API rejects invalid latitude values

**Preconditions**:
- Developer console or API testing tool available

**Test Steps**:
1. Manually craft POST request to `/api/somethings/[valid-id]/organize`:
   ```json
   {
     "realm": "physical",
     "location_name": "Test Location",
     "latitude": -91,
     "longitude": 100,
     "care": 3
   }
   ```
2. Send request

**Expected Results**:
- ✅ API returns 400 Bad Request
- ✅ Error message: "Invalid latitude (must be -90 to 90)" or similar
- ✅ Database record NOT updated

**Pass/Fail**: ______
**Notes**: ___________________________________________

---

### **TC-05: Coordinate Range Validation (Invalid Longitude)**

**Priority**: P0 (Critical)
**AC Reference**: AC 6

**Objective**: Verify API rejects invalid longitude values

**Preconditions**:
- Developer console or API testing tool available

**Test Steps**:
1. Manually craft POST request to `/api/somethings/[valid-id]/organize`:
   ```json
   {
     "realm": "physical",
     "location_name": "Test Location",
     "latitude": 40,
     "longitude": 181,
     "care": 3
   }
   ```
2. Send request

**Expected Results**:
- ✅ API returns 400 Bad Request
- ✅ Error message: "Invalid longitude (must be -180 to 180)" or similar
- ✅ Database record NOT updated

**Pass/Fail**: ______
**Notes**: ___________________________________________

---

### **TC-06: Manual Entry Fallback with Warning**

**Priority**: P0 (Critical)
**AC Reference**: AC 8

**Objective**: Verify user can submit text without selecting autocomplete (coordinates NULL)

**Preconditions**:
- User is on Chamber page with Physical realm selected

**Test Steps**:
1. Expand capture organization panel
2. Select "Physical" realm
3. Type "My Secret Spot" in location input (obscure location Mapbox won't find)
4. Do NOT click any autocomplete suggestions
5. Press Tab or click outside input to blur
6. Select care level (1-5)
7. Click "Organize" button
8. Observe for warning message

**Expected Results**:
- ✅ Warning message appears: "⚠️ No coordinates captured. Your location won't appear on the map until geocoded." (or similar)
- ✅ Organization succeeds (capture moves to care container)
- ✅ Database record created with:
  - `location_name`: "My Secret Spot"
  - `latitude`: NULL
  - `longitude`: NULL
  - `formatted_address`: NULL or empty
- ✅ No blocking error preventing submission

**Pass/Fail**: ______
**Notes**: ___________________________________________

---

### **TC-07: Mind Realm Does Not Require Coordinates**

**Priority**: P1 (Should Test)
**AC Reference**: AC 7 (inverse test)

**Objective**: Verify Mind realm can be organized without coordinates

**Preconditions**:
- User is on Chamber page with unorganized capture

**Test Steps**:
1. Expand capture organization panel
2. Select "Mind" realm radio button
3. Observe location input is disabled or hidden (per Story 2.4 design)
4. Select care level (1-5)
5. Click "Organize" button

**Expected Results**:
- ✅ Organization succeeds without location data
- ✅ No coordinate fields required
- ✅ Database record has:
  - `realm`: 'mind'
  - `latitude`: NULL
  - `longitude`: NULL
  - `location_name`: NULL or empty

**Pass/Fail**: ______
**Notes**: ___________________________________________

---

### **TC-08: Keyboard Navigation (Arrow Keys)**

**Priority**: P0 (Critical - Accessibility)
**AC Reference**: AC 16

**Objective**: Verify keyboard arrow keys navigate autocomplete suggestions

**Preconditions**:
- Autocomplete dropdown is visible with multiple suggestions

**Test Steps**:
1. Type "San Diego" in location input
2. Wait for suggestions to appear
3. Press **Arrow Down** key
4. Observe first suggestion is highlighted
5. Press **Arrow Down** again
6. Observe second suggestion is highlighted
7. Press **Arrow Up**
8. Observe first suggestion is highlighted again

**Expected Results**:
- ✅ Arrow Down moves highlight to next suggestion
- ✅ Arrow Up moves highlight to previous suggestion
- ✅ Visual highlight clearly indicates selected item
- ✅ `aria-activedescendant` attribute updates (check DevTools)

**Pass/Fail**: ______
**Notes**: ___________________________________________

---

### **TC-09: Keyboard Navigation (Enter Key)**

**Priority**: P0 (Critical - Accessibility)
**AC Reference**: AC 16

**Objective**: Verify Enter key selects highlighted suggestion

**Preconditions**:
- Autocomplete dropdown is visible

**Test Steps**:
1. Type "La Jolla" in location input
2. Wait for suggestions
3. Press Arrow Down to highlight first suggestion
4. Press **Enter** key

**Expected Results**:
- ✅ Input field updates with selected place name
- ✅ Dropdown closes
- ✅ Coordinates captured (same as TC-02)

**Pass/Fail**: ______
**Notes**: ___________________________________________

---

### **TC-10: Keyboard Navigation (Escape Key)**

**Priority**: P1 (Should Test)
**AC Reference**: AC 16

**Objective**: Verify Escape key closes dropdown without selection

**Preconditions**:
- Autocomplete dropdown is visible

**Test Steps**:
1. Type "San Diego" in location input
2. Wait for suggestions
3. Press **Escape** key

**Expected Results**:
- ✅ Dropdown closes
- ✅ Input field retains typed text ("San Diego")
- ✅ No coordinates captured

**Pass/Fail**: ______
**Notes**: ___________________________________________

---

### **TC-11: Keyboard Navigation (Tab Key)**

**Priority**: P1 (Should Test)
**AC Reference**: AC 16

**Objective**: Verify Tab key closes dropdown and moves focus

**Preconditions**:
- Autocomplete dropdown is visible

**Test Steps**:
1. Type "La Jolla" in location input
2. Wait for suggestions
3. Press **Tab** key

**Expected Results**:
- ✅ Dropdown closes
- ✅ Focus moves to next form field (care level selector)
- ✅ No coordinates captured

**Pass/Fail**: ______
**Notes**: ___________________________________________

---

### **TC-12: Loading State Indicator**

**Priority**: P1 (Should Test)
**AC Reference**: AC 14

**Objective**: Verify loading indicator displays while fetching suggestions

**Preconditions**:
- Network throttled to "Slow 3G" (Chrome DevTools)

**Test Steps**:
1. Open Chrome DevTools → Network tab → Throttling dropdown → Select "Slow 3G"
2. Type "San Diego" in location input
3. Observe UI immediately after typing (within 300ms debounce window)

**Expected Results**:
- ✅ Loading spinner or "Loading..." text appears
- ✅ Loading indicator disappears when suggestions arrive
- ✅ User cannot click suggestions until loading completes

**Pass/Fail**: ______
**Notes**: ___________________________________________

---

### **TC-13: API Error Handling - Mapbox Failure**

**Priority**: P0 (Critical)
**AC Reference**: AC 15

**Objective**: Verify graceful error handling when Mapbox API fails

**Preconditions**:
- Simulate API failure (block Mapbox domain in DevTools or use invalid token)

**Test Steps**:
1. Temporarily modify `.env.local` to use invalid Mapbox token (e.g., `NEXT_PUBLIC_MAPBOX_TOKEN=invalid`)
2. Restart dev server (`pnpm dev`)
3. Type "San Diego" in location input
4. Wait for API call to fail

**Expected Results**:
- ✅ Error message displays: "Unable to fetch location suggestions" (or similar)
- ✅ User can still type manually in input field
- ✅ Manual entry fallback works (TC-06 behavior)
- ✅ No JavaScript console errors crash the UI

**Pass/Fail**: ______
**Notes**: ___________________________________________

---

### **TC-14: Accessibility - Screen Reader Announcements**

**Priority**: P1 (Should Test - WCAG 2.1 AA)
**AC Reference**: AC 16

**Objective**: Verify screen reader announces dropdown state changes

**Preconditions**:
- Screen reader enabled (NVDA/JAWS on Windows, VoiceOver on Mac)

**Test Steps**:
1. Enable screen reader
2. Focus on location input field
3. Type "La Jolla"
4. Listen for screen reader announcements

**Expected Results**:
- ✅ Screen reader announces: "Location search, edit text" (or similar)
- ✅ When dropdown opens: "5 suggestions available" (or similar)
- ✅ When navigating with arrows: "La Jolla, California, 1 of 5"
- ✅ `aria-expanded="true"` when dropdown is open
- ✅ `role="combobox"` on input
- ✅ `role="listbox"` on dropdown
- ✅ `role="option"` on each suggestion

**Pass/Fail**: ______
**Notes**: ___________________________________________

---

### **TC-15: Spatial Index Verification**

**Priority**: P2 (Nice to Have)
**AC Reference**: AC 12

**Objective**: Verify spatial index created for performance (Story 2.7 readiness)

**Preconditions**:
- Database migration applied

**Test Steps**:
1. Run SQL query in Supabase Studio:
   ```sql
   SELECT indexname, indexdef
   FROM pg_indexes
   WHERE tablename = 'somethings'
   AND indexname = 'idx_somethings_location';
   ```

**Expected Results**:
- ✅ Index `idx_somethings_location` exists
- ✅ Index definition includes: `(user_id, latitude, longitude) WHERE latitude IS NOT NULL`

**Pass/Fail**: ______
**Notes**: ___________________________________________

---

### **TC-16: Environment Variable Configuration**

**Priority**: P0 (Critical)
**AC Reference**: AC 13

**Objective**: Verify Mapbox token is accessible in client components

**Preconditions**:
- `.env.local` contains `NEXT_PUBLIC_MAPBOX_TOKEN`

**Test Steps**:
1. Open browser DevTools → Console
2. Type: `console.log(process.env.NEXT_PUBLIC_MAPBOX_TOKEN)`
3. Observe output (Note: In Next.js client, this won't work directly - check Network tab instead)
4. Alternative: Check Network tab for Mapbox API calls with `access_token` parameter

**Expected Results**:
- ✅ Network requests to Mapbox include `access_token=pk.eyJ...` (valid public token)
- ✅ Token starts with `pk.` (public token prefix)
- ✅ `.env.example` exists with placeholder: `NEXT_PUBLIC_MAPBOX_TOKEN=your_mapbox_token_here`

**Pass/Fail**: ______
**Notes**: ___________________________________________

---

### **TC-17: Debounce Functionality (300ms)**

**Priority**: P1 (Should Test)
**AC Reference**: AC 2 (implied)

**Objective**: Verify autocomplete waits 300ms before fetching to avoid excessive API calls

**Preconditions**:
- Network tab open in DevTools

**Test Steps**:
1. Rapidly type "San Diego" character by character (< 300ms between keystrokes)
2. Observe Network tab for Mapbox API calls

**Expected Results**:
- ✅ NO API calls made during rapid typing
- ✅ Single API call made 300ms after last keystroke
- ✅ If user types "San", waits 300ms, types "Diego", only 1 call for "SanDiego" is made

**Pass/Fail**: ______
**Notes**: ___________________________________________

---

### **TC-18: State Management Across Realm Changes**

**Priority**: P1 (Should Test)
**AC Reference**: AC 9

**Objective**: Verify coordinates are cleared when switching from Physical to Mind realm

**Preconditions**:
- Capture organization panel open

**Test Steps**:
1. Select "Physical" realm
2. Search and select "La Jolla, California" (coordinates captured)
3. Switch to "Mind" realm radio button
4. Observe location input state
5. Switch back to "Physical" realm
6. Observe location input state

**Expected Results**:
- ✅ When switching to Mind: coordinates cleared from state
- ✅ Location input disabled/hidden in Mind realm
- ✅ When switching back to Physical: input is empty (coordinates not retained)
- ✅ User must re-search location

**Pass/Fail**: ______
**Notes**: ___________________________________________

---

### **TC-19: Story 2.7 Readiness - Query for Mappable Somethings**

**Priority**: P0 (Critical - Story Dependency)
**AC Reference**: AC 17

**Objective**: Verify Physical somethings with coordinates can be queried for map rendering

**Preconditions**:
- At least 2 Physical somethings organized:
  - 1 with coordinates (via autocomplete selection)
  - 1 without coordinates (manual entry fallback)

**Test Steps**:
1. Run SQL query in Supabase Studio:
   ```sql
   SELECT id, location_name, latitude, longitude, care, realm
   FROM somethings
   WHERE realm = 'physical'
   AND latitude IS NOT NULL
   AND longitude IS NOT NULL
   ORDER BY care DESC;
   ```

**Expected Results**:
- ✅ Query returns only Physical somethings with coordinates
- ✅ Manual entry fallback somethings (NULL coordinates) are excluded
- ✅ Results include all required fields for Story 2.7 map markers:
  - `latitude` (number)
  - `longitude` (number)
  - `location_name` (string)
  - `care` (integer 1-5)

**Pass/Fail**: ______
**Notes**: ___________________________________________

---

### **TC-20: Multiple Autocomplete Selections (Session Persistence)**

**Priority**: P2 (Nice to Have)
**AC Reference**: AC 4, 5

**Objective**: Verify user can organize multiple captures with different locations in one session

**Preconditions**:
- At least 3 unorganized captures

**Test Steps**:
1. Organize first capture as Physical with "La Jolla, California"
2. Organize second capture as Physical with "San Diego, California"
3. Organize third capture as Physical with "Encinitas, California"
4. Query database for all 3 somethings

**Expected Results**:
- ✅ All 3 somethings saved with unique coordinates
- ✅ Each has correct `latitude`, `longitude`, `formatted_address`
- ✅ No coordinate data "bleeding" between entries
- ✅ State resets correctly between organizations

**Pass/Fail**: ______
**Notes**: ___________________________________________

---

## Risk-Based Test Prioritization

### P0 (Critical - Must Test)
- TC-01: Mapbox Autocomplete Integration
- TC-02: Location Selection & Coordinate Capture
- TC-03: Database Coordinate Storage
- TC-04: Coordinate Range Validation (Invalid Latitude)
- TC-05: Coordinate Range Validation (Invalid Longitude)
- TC-06: Manual Entry Fallback with Warning
- TC-08: Keyboard Navigation (Arrow Keys)
- TC-09: Keyboard Navigation (Enter Key)
- TC-13: API Error Handling - Mapbox Failure
- TC-16: Environment Variable Configuration
- TC-19: Story 2.7 Readiness

**Total P0 Cases**: 11

### P1 (Should Test)
- TC-07: Mind Realm Does Not Require Coordinates
- TC-10: Keyboard Navigation (Escape Key)
- TC-11: Keyboard Navigation (Tab Key)
- TC-12: Loading State Indicator
- TC-14: Accessibility - Screen Reader Announcements
- TC-17: Debounce Functionality
- TC-18: State Management Across Realm Changes

**Total P1 Cases**: 7

### P2 (Nice to Have)
- TC-15: Spatial Index Verification
- TC-20: Multiple Autocomplete Selections

**Total P2 Cases**: 2

---

## Test Execution Summary

**Total Test Cases**: 20
**Estimated Execution Time**: 45-60 minutes (full suite)

### Test Completion Checklist

- [ ] All P0 test cases executed
- [ ] All P1 test cases executed (if time permits)
- [ ] P2 test cases executed (optional)
- [ ] All defects logged with severity
- [ ] Test results documented in this file
- [ ] Test evidence captured (screenshots for critical failures)

---

## Defect Tracking Template

| TC ID | Severity | Description | Steps to Reproduce | Expected | Actual | Status |
|-------|----------|-------------|-------------------|----------|--------|--------|
| TC-XX | Critical/High/Medium/Low | Brief description | 1. Step 1<br>2. Step 2 | Expected result | Actual result | Open/Fixed/Wont Fix |

---

## Sign-Off

**Test Architect**: Quinn
**Test Plan Review Date**: 2025-11-05
**Test Execution Date**: ___________
**Test Results**: PASS / FAIL / BLOCKED
**Overall Status**: Ready for Production / Requires Fixes / Blocked by Dependencies

**Notes**:
___________________________________________
___________________________________________
___________________________________________
