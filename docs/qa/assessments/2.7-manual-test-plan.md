# Manual Test Plan: Story 2.7 - Physical Map 3D Buildings, Markers & Experience List

**Story**: 2.7 - Physical Map - 3D Buildings, Markers & Experience List
**Test Date**: _________________
**Tested By**: _________________
**Environment**: _________________
**Build/Commit**: _________________

---

## Pre-Test Setup

### Prerequisites

- [ ] Supabase running locally (`supabase start`) or connected to cloud instance
- [ ] Development server running (`pnpm dev`)
- [ ] Test user account created and logged in
- [ ] Mapbox token configured in `.env.local`
- [ ] Browser DevTools open (Console + Network tabs)

### Test Data Required

Create at least the following test data via the `/capture` page:

- [ ] **3 Physical somethings at the same location** (e.g., "UCSD Price Center")
  - Varying care ratings (1, 3, 5)
  - Different timestamps
  - Different text content
- [ ] **2 Physical somethings at different locations** (e.g., "Downtown San Diego", "La Jolla Cove")
- [ ] **1 Physical something with a very long text** (200+ characters)
- [ ] **1 Physical something with no care rating** (if possible via direct DB insert)

**Total**: At least 6 Physical somethings with coordinates

**Note**: Use the location search in capture page to ensure coordinates are geocoded.

---

## Test Execution

### Section 1: 3D Map Configuration (AC 1)

#### Test 1.1: Initial Map Load with 3D View

**Steps:**
1. Navigate to `/my_reality`
2. Wait for map to fully load
3. Observe the initial camera angle

**Expected Results:**
- [ ] Map loads without errors
- [ ] Camera is tilted (not top-down view) - bird's eye perspective visible
- [ ] Map appears smooth (no jagged edges on map elements)
- [ ] Console shows no errors related to Mapbox

**Visual Verification:**
- [ ] Can see the curvature/tilt of the map (not flat top-down)
- [ ] Pitch control buttons appear in top-right (+ and - for tilt)

**Notes:**
_________________________________________________________________

---

### Section 2: 3D Building Rendering (AC 2)

#### Test 2.1: No Buildings on Initial Load

**Steps:**
1. On initial map load at world view (zoom 2)
2. Pan around the map
3. Zoom in to zoom level 15+ without searching

**Expected Results:**
- [ ] No 3D buildings visible on initial load
- [ ] Map shows minimal grey land and blue water only
- [ ] Panning/zooming works smoothly

**Notes:**
_________________________________________________________________

#### Test 2.2: Buildings Appear After Location Search

**Steps:**
1. Click the location search bar at bottom-center
2. Type "UCSD" (or any location where you have test data)
3. Select location from dropdown
4. Wait for map to animate to location
5. Observe the map at zoom 15+

**Expected Results:**
- [ ] Map smoothly animates to searched location
- [ ] 3D buildings appear with extrusion/height
- [ ] Buildings are semi-transparent (can see through them slightly)
- [ ] Buildings appear grey (#aaa color)
- [ ] Large location name label appears on map
- [ ] Black boundary outline appears around the searched area

**Visual Verification:**
- [ ] Buildings have visible height (not flat)
- [ ] Buildings cast shadows or show 3D perspective
- [ ] Can tilt camera up/down to see buildings from different angles

**Notes:**
_________________________________________________________________

#### Test 2.3: Buildings at Different Zoom Levels

**Steps:**
1. With buildings visible from previous test
2. Zoom out slowly from zoom 16 → 15 → 14
3. Observe when buildings disappear

**Expected Results:**
- [ ] Buildings visible at zoom >= 15
- [ ] Buildings disappear/fade when zoom < 15
- [ ] Transition is smooth (no jarring pop)

**Notes:**
_________________________________________________________________

---

### Section 3: Marker Display & Care-Based Brightness (AC 3, 4, 5)

#### Test 3.1: Markers Appear on Map

**Steps:**
1. Ensure you have created test data (6+ Physical somethings)
2. Navigate to `/my_reality`
3. Pan/zoom to locations where you created test data

**Expected Results:**
- [ ] Red circular markers appear at each location
- [ ] Markers have white border (2px)
- [ ] Markers are visible on top of 3D buildings (if buildings present)
- [ ] Number of markers matches number of unique locations (not total somethings)

**Count Verification:**
- Expected markers: _______ (1 for UCSD, 1 for Downtown SD, 1 for La Jolla)
- Actual markers seen: _______

**Notes:**
_________________________________________________________________

#### Test 3.2: Care-Based Brightness Variation

**Steps:**
1. Locate markers for somethings with different care ratings
2. Compare brightness/opacity visually

**Expected Results:**
- [ ] Care 1 (Ugly) markers are very dim (barely visible but not invisible)
- [ ] Care 3 (Neutral) markers are medium brightness
- [ ] Care 5 (Beautiful) markers are bright/vivid
- [ ] All markers are still visible (minimum opacity 0.2)

**Visual Scale Check:**
- Dimmest marker opacity: _______ (should be ~0.2)
- Brightest marker opacity: _______ (should be ~1.0)

**Notes:**
_________________________________________________________________

#### Test 3.3: Marker Hover Effect

**Steps:**
1. Hover mouse over a marker (don't click yet)
2. Move mouse away
3. Repeat with different markers

**Expected Results:**
- [ ] Marker opacity increases to 1.0 on hover
- [ ] Cursor changes to pointer (clickable indicator)
- [ ] Marker returns to original opacity when mouse leaves
- [ ] Hover effect is smooth (has transition)

**Notes:**
_________________________________________________________________

#### Test 3.4: Grouped Markers (Multiple Somethings at Same Location)

**Steps:**
1. Navigate to UCSD location (where you created 3 somethings)
2. Count markers at that exact location

**Expected Results:**
- [ ] Only ONE marker appears for all 3 somethings at same location
- [ ] Marker brightness is average of all care ratings
  - Example: care [1, 3, 5] → average 3 → brightness 0.5

**Calculation Check:**
- Somethings at location: _______
- Care ratings: _______
- Expected average care: _______
- Expected brightness: _______ (use formula: (care - 1) / 4)

**Notes:**
_________________________________________________________________

---

### Section 4: Marker Click → Experience List Modal (AC 6, 7)

#### Test 4.1: Open Modal on Marker Click

**Steps:**
1. Click on the marker at UCSD (with 3 somethings)
2. Observe modal appearance

**Expected Results:**
- [ ] Modal opens immediately on click
- [ ] Dark backdrop appears behind modal (70% black with blur)
- [ ] Modal displays location name "UCSD" (or user's location_name)
- [ ] Experience count shows "3 experiences"
- [ ] Background body scroll is disabled

**Desktop (>= 768px):**
- [ ] Modal centered on screen
- [ ] Max width 600px
- [ ] Rounded corners on all sides

**Mobile (< 768px):**
- [ ] Modal slides up from bottom (bottom sheet)
- [ ] Full width
- [ ] Rounded top corners only
- [ ] Can swipe/scroll within modal

**Notes:**
_________________________________________________________________

#### Test 4.2: Experience List Content Display

**Steps:**
1. With modal open from previous test
2. Examine each experience in the list

**Expected Results:**

For each experience:
- [ ] Timestamp formatted correctly (e.g., "Nov 5, 2025, 3:45 PM")
- [ ] Text preview shows first 100 characters
- [ ] Text ending with "..." if longer than 100 characters
- [ ] Care rating displayed as stars (★★★★☆ for care 4)
  - Filled stars: yellow (#fbbf24)
  - Empty stars: grey (#4b5563)
- [ ] "View Details" button present and styled blue

**Sorting Verification:**
- [ ] Experiences sorted by most recent first (newest at top)
- First experience timestamp: _______
- Last experience timestamp: _______

**Accessibility Check:**
- [ ] Care stars have aria-label (inspect in DevTools)
- [ ] Modal has role="dialog" and aria-modal="true"
- [ ] Modal title has id="modal-title"

**Notes:**
_________________________________________________________________

#### Test 4.3: Long Text Truncation

**Steps:**
1. Find the experience with 200+ character text
2. Observe how it displays in modal

**Expected Results:**
- [ ] Only first 100 characters shown
- [ ] Text ends with "..."
- [ ] No text overflow or layout breaking
- [ ] Line clamp works (max 3 lines with line-clamp-3)

**Notes:**
_________________________________________________________________

#### Test 4.4: Empty State

**Steps:**
1. Close modal
2. Use direct database access to create a Physical something with coordinates but at a NEW location (no other somethings there)
3. Refresh map
4. Click the new marker

**Expected Results:**
- [ ] Modal opens
- [ ] Message: "No experiences recorded at this location yet"
- [ ] Empty state centered and grey colored
- [ ] Close button still works

**Notes:**
_________________________________________________________________

---

### Section 5: Modal Interaction & Closing (AC 6, 9)

#### Test 5.1: Close Modal via Close Button

**Steps:**
1. Open modal by clicking marker
2. Click "Close" button at bottom of modal

**Expected Results:**
- [ ] Modal closes immediately
- [ ] Backdrop disappears
- [ ] Body scroll re-enabled
- [ ] Map remains in same position

**Notes:**
_________________________________________________________________

#### Test 5.2: Close Modal via Backdrop Click

**Steps:**
1. Open modal
2. Click on dark backdrop area (outside modal)

**Expected Results:**
- [ ] Modal closes
- [ ] Map remains interactive

**Notes:**
_________________________________________________________________

#### Test 5.3: Close Modal via ESC Key

**Steps:**
1. Open modal
2. Press ESC key on keyboard

**Expected Results:**
- [ ] Modal closes immediately
- [ ] Keyboard shortcut works consistently

**Notes:**
_________________________________________________________________

#### Test 5.4: Modal Scrolling (Long List)

**Steps:**
1. If you have 10+ experiences at one location, open that modal
2. Scroll within the experience list

**Expected Results:**
- [ ] List scrolls smoothly within modal
- [ ] Modal header stays fixed at top
- [ ] Close button stays fixed at bottom
- [ ] Background doesn't scroll (body scroll locked)
- [ ] Scrollbar appears in experience list area only

**Note**: If you don't have 10+ experiences, skip this test or create more test data.

**Notes:**
_________________________________________________________________

---

### Section 6: Navigation to Detail Page (AC 8)

#### Test 6.1: View Details Navigation

**Steps:**
1. Open modal with experiences
2. Click "View Details" button on first experience
3. Observe navigation

**Expected Results:**
- [ ] Navigate to `/my_reality/[id]` route
- [ ] URL contains correct experience ID
- [ ] Detail page loads without errors
- [ ] Modal closes automatically on navigation

**URL Check:**
- Expected pattern: `/my_reality/abc123...`
- Actual URL: _______

**Notes:**
_________________________________________________________________

#### Test 6.2: Detail Page Content Display

**Steps:**
1. On detail page from previous test
2. Verify all content displays correctly

**Expected Results:**
- [ ] Realm badge displays ("Physical" in blue)
- [ ] Location name displayed as H1 heading
- [ ] Formatted address displayed below location name
- [ ] Timestamp formatted with full date (e.g., "Monday, November 5, 2025, 3:45 PM")
- [ ] Care rating stars (larger, 2xl size)
- [ ] Full text content displayed (not truncated)
- [ ] Text preserves line breaks (whitespace-pre-wrap)

**If media present:**
- [ ] Photo displays with rounded corners
- [ ] Video has controls
- [ ] Link has proper styling and opens in new tab

**Footer info:**
- [ ] Coordinates displayed (if present) with 6 decimal precision
- [ ] ID, Created, Updated timestamps in small grey text

**Notes:**
_________________________________________________________________

#### Test 6.3: Back to Map Navigation

**Steps:**
1. On detail page
2. Click "Back to Map" link in header

**Expected Results:**
- [ ] Navigate back to `/my_reality`
- [ ] Map loads in same position (URL params preserved)
- [ ] All markers still visible

**Notes:**
_________________________________________________________________

#### Test 6.4: Detail Page Auth Check

**Steps:**
1. Open detail page URL in private/incognito window (not logged in)

**Expected Results:**
- [ ] Redirect to `/login` page
- [ ] No flash of content before redirect
- [ ] After login, can access detail page

**Notes:**
_________________________________________________________________

---

### Section 7: Map Controls & Interaction (AC 10)

#### Test 7.1: Zoom Controls

**Steps:**
1. On map page
2. Click zoom in (+) button multiple times
3. Click zoom out (-) button multiple times

**Expected Results:**
- [ ] Zoom in button increases zoom level
- [ ] Zoom out button decreases zoom level
- [ ] Zoom level indicator updates in bottom-left (e.g., "City View")
- [ ] Smooth zoom animation
- [ ] URL updates with new zoom level (debounced, check after 500ms)

**Zoom Range Check:**
- Min zoom: _______ (should allow 0)
- Max zoom: _______ (should allow 20)

**Notes:**
_________________________________________________________________

#### Test 7.2: Pitch Controls (Tilt Camera)

**Steps:**
1. Locate pitch control buttons in top-right (up/down arrows)
2. Click up arrow to increase tilt
3. Click down arrow to decrease tilt
4. Try tilting to maximum and minimum

**Expected Results:**
- [ ] Up arrow tilts camera more (increases pitch)
- [ ] Down arrow levels camera (decreases pitch)
- [ ] Smooth tilt animation
- [ ] Can see 3D buildings better at higher pitch
- [ ] Max pitch: 60° (very tilted bird's eye view)
- [ ] Min pitch: 0° (top-down view)

**Notes:**
_________________________________________________________________

#### Test 7.3: Rotation Disabled

**Steps:**
1. Try to rotate map by:
   - Right-click drag (desktop)
   - Ctrl + drag (desktop)
   - Two-finger rotate (mobile/trackpad)

**Expected Results:**
- [ ] Map does NOT rotate
- [ ] North always stays up
- [ ] Compass control NOT visible (rotation disabled)
- [ ] No bearing changes

**Notes:**
_________________________________________________________________

#### Test 7.4: Touch Pitch (Mobile/Trackpad)

**Steps:**
1. On mobile device or with trackpad
2. Use two-finger drag up/down

**Expected Results:**
- [ ] Two-finger drag tilts camera (changes pitch)
- [ ] Same effect as pitch control buttons
- [ ] Smooth gesture recognition

**Notes:**
_________________________________________________________________

#### Test 7.5: URL State Persistence

**Steps:**
1. Pan map to new location
2. Zoom to specific level (e.g., 12)
3. Wait 1 second (debounce)
4. Check URL in address bar
5. Copy URL
6. Open URL in new tab

**Expected Results:**
- [ ] URL contains `?lat=X&lng=Y&zoom=Z` parameters
- [ ] Lat/Lng values match map center (4 decimal places)
- [ ] Zoom value matches current zoom (rounded to integer)
- [ ] Opening URL in new tab loads map at same position

**URL Format Check:**
- Example: `/my_reality?lat=32.8810&lng=-117.2340&zoom=15`
- Actual URL: _______

**Notes:**
_________________________________________________________________

---

### Section 8: Location Search Integration (AC 2 related)

#### Test 8.1: Search for Location

**Steps:**
1. Click location search bar at bottom-center
2. Type "San Diego, CA"
3. Select from dropdown results

**Expected Results:**
- [ ] Search bar displays suggestions while typing
- [ ] Selecting location triggers smooth fly-to animation
- [ ] Map centers on selected location
- [ ] Zoom adjusts to appropriate level for location type
- [ ] 3D buildings appear for searched location
- [ ] Large location name label appears on map
- [ ] Black boundary outline appears around location

**Animation Timing:**
- [ ] Animation duration: ~2 seconds (smooth, not instant)
- [ ] Padding keeps location above search bar (200px bottom padding)

**Notes:**
_________________________________________________________________

#### Test 8.2: Search Persistence After Reload

**Steps:**
1. Search for location (3D buildings appear)
2. Refresh page (F5 or Cmd+R)
3. Wait for map to reload

**Expected Results:**
- [ ] Map loads at same position (URL params used)
- [ ] Location label reappears on map
- [ ] 3D buildings reappear (search state persisted)
- [ ] Boundary outline reappears

**Notes:**
_________________________________________________________________

---

### Section 9: API & Data Flow (AC 3)

#### Test 9.1: Physical Somethings API Call

**Steps:**
1. Open DevTools Network tab
2. Navigate to `/my_reality`
3. Find request to `/api/somethings/physical`

**Expected Results:**
- [ ] Single API call made on page load
- [ ] Request method: GET
- [ ] Response status: 200 OK
- [ ] Response contains array of Physical somethings
- [ ] Only somethings with realm='physical' returned
- [ ] Only somethings with non-null latitude/longitude returned
- [ ] Somethings sorted by captured_at descending (newest first)

**Response Verification:**
- Number of somethings in response: _______
- First something captured_at: _______
- Last something captured_at: _______
- All have latitude/longitude: [ ] Yes [ ] No

**Notes:**
_________________________________________________________________

#### Test 9.2: Unauthorized Access

**Steps:**
1. Open Network tab
2. Clear browser cookies (log out)
3. Try to access `/api/somethings/physical` directly

**Expected Results:**
- [ ] Response status: 401 Unauthorized
- [ ] Response body: `{ "error": "Unauthorized" }`
- [ ] No somethings data returned

**Notes:**
_________________________________________________________________

---

### Section 10: Responsive Design (AC 9)

#### Test 10.1: Desktop View (>= 768px)

**Steps:**
1. Set browser width to 1200px
2. Open modal by clicking marker

**Expected Results:**
- [ ] Modal centered on screen
- [ ] Modal max-width: 600px
- [ ] Modal has backdrop blur
- [ ] Rounded corners on all sides (rounded-lg)
- [ ] Modal max-height: 80vh (doesn't exceed viewport)

**Notes:**
_________________________________________________________________

#### Test 10.2: Mobile View (< 768px)

**Steps:**
1. Set browser width to 375px (iPhone size) or use mobile device
2. Open modal by clicking marker

**Expected Results:**
- [ ] Modal slides up from bottom (bottom sheet style)
- [ ] Modal full width (left: 0, right: 0)
- [ ] Rounded top corners only (rounded-t-2xl)
- [ ] No rounded bottom corners
- [ ] Modal max-height: 60vh for content area

**Notes:**
_________________________________________________________________

#### Test 10.3: Tablet View (768px - 1024px)

**Steps:**
1. Set browser width to 768px (iPad portrait)
2. Test all modal and map interactions

**Expected Results:**
- [ ] Modal uses desktop centered style (breakpoint md:)
- [ ] All controls accessible
- [ ] Touch gestures work (pitch, pan, zoom)

**Notes:**
_________________________________________________________________

---

### Section 11: Error Handling & Edge Cases

#### Test 11.1: Missing Mapbox Token

**Steps:**
1. Stop dev server
2. Remove or invalidate NEXT_PUBLIC_MAPBOX_TOKEN in .env.local
3. Restart dev server
4. Navigate to `/my_reality`

**Expected Results:**
- [ ] Error message displays: "Mapbox token not configured..."
- [ ] Link to Mapbox account page provided
- [ ] Helpful instructions for adding token to .env.local
- [ ] No console errors (graceful error state)

**Cleanup:**
- [ ] Restore valid Mapbox token
- [ ] Restart dev server

**Notes:**
_________________________________________________________________

#### Test 11.2: No Physical Somethings

**Steps:**
1. Delete all Physical somethings from database (keep Mind somethings if any)
2. Navigate to `/my_reality`

**Expected Results:**
- [ ] Map loads successfully
- [ ] No markers appear on map
- [ ] No API errors in console
- [ ] No visual errors or broken UI
- [ ] Can still search locations and see 3D buildings

**Cleanup:**
- [ ] Recreate test data

**Notes:**
_________________________________________________________________

#### Test 11.3: API Error Simulation

**Steps:**
1. Open DevTools Network tab
2. Throttle network to "Offline"
3. Refresh `/my_reality` page

**Expected Results:**
- [ ] Map still loads (Mapbox tiles may fail)
- [ ] API call fails gracefully
- [ ] Console shows error but app doesn't crash
- [ ] No markers appear (expected with failed API)

**Cleanup:**
- [ ] Restore network to "Online"

**Notes:**
_________________________________________________________________

#### Test 11.4: Marker at Edge of Map

**Steps:**
1. Create Physical something at extreme coordinates (e.g., 85°N latitude)
2. Navigate to that marker

**Expected Results:**
- [ ] Marker renders correctly
- [ ] Map navigates to location without errors
- [ ] No layout breaking or coordinate issues

**Notes:**
_________________________________________________________________

---

### Section 12: Performance & Visual Quality

#### Test 12.1: Map Load Time

**Steps:**
1. Open DevTools Performance tab
2. Record while loading `/my_reality`
3. Stop recording after full load

**Expected Results:**
- [ ] Map loads within 3 seconds (normal connection)
- [ ] No significant frame drops during load
- [ ] Smooth 60fps during pan/zoom
- [ ] No layout shifts after initial load

**Timing:**
- Time to first map render: _______
- Time to markers appear: _______
- Total load time: _______

**Notes:**
_________________________________________________________________

#### Test 12.2: 3D Building Render Quality

**Steps:**
1. Search for location with tall buildings (e.g., "Downtown San Diego")
2. Zoom to level 17 (close up)
3. Observe building edges and surfaces

**Expected Results:**
- [ ] Building edges are smooth (antialiasing enabled)
- [ ] No jagged/pixelated edges
- [ ] Buildings render with correct perspective
- [ ] Smooth transitions when zooming in/out

**Notes:**
_________________________________________________________________

#### Test 12.3: Marker Clustering Performance (If 100+ Markers)

**Steps:**
1. If you have 100+ Physical somethings, load map
2. Pan around map

**Expected Results:**
- [ ] Map remains responsive with many markers
- [ ] No significant lag when panning
- [ ] All markers render correctly

**Note**: This test is optional unless you have large dataset.

**Notes:**
_________________________________________________________________

---

### Section 13: Browser Compatibility

#### Test 13.1: Chrome/Edge (Chromium)

**Browser**: _____________ **Version**: _____________

**Results:**
- [ ] All features work as expected
- [ ] No console errors
- [ ] Visual rendering correct

**Notes:**
_________________________________________________________________

#### Test 13.2: Firefox

**Browser**: Firefox **Version**: _____________

**Results:**
- [ ] All features work as expected
- [ ] No console errors
- [ ] Visual rendering correct

**Notes:**
_________________________________________________________________

#### Test 13.3: Safari (macOS/iOS)

**Browser**: Safari **Version**: _____________

**Results:**
- [ ] All features work as expected
- [ ] No console errors
- [ ] Visual rendering correct
- [ ] Touch gestures work on iOS

**Notes:**
_________________________________________________________________

---

## Test Summary

### Overall Assessment

**Total Test Cases**: 46
**Passed**: _______
**Failed**: _______
**Skipped**: _______
**Blocked**: _______

### Critical Issues Found

1. _________________________________________________________________
2. _________________________________________________________________
3. _________________________________________________________________

### Non-Critical Issues Found

1. _________________________________________________________________
2. _________________________________________________________________
3. _________________________________________________________________

### Recommendations

_________________________________________________________________
_________________________________________________________________
_________________________________________________________________

### Sign-Off

**Tested By**: _______________________
**Date**: _______________________
**Status**: [ ] PASS [ ] FAIL [ ] PASS WITH CONCERNS

**Notes:**
_________________________________________________________________
_________________________________________________________________
_________________________________________________________________

---

## Appendix: Quick Reference

### Key URLs
- Map page: `http://localhost:3000/my_reality`
- Capture page: `http://localhost:3000/capture`
- API endpoint: `http://localhost:3000/api/somethings/physical`

### Key Keyboard Shortcuts
- **ESC**: Close modal
- **Shift + Zoom**: Zoom while keeping center point fixed

### Test Data SQL (Quick Create)

```sql
-- Create Physical something with coordinates (run in Supabase SQL editor)
INSERT INTO somethings (
  user_id, realm, location_name, formatted_address,
  latitude, longitude, care, text_content,
  content_type, captured_at
) VALUES (
  auth.uid(),
  'physical',
  'Test Location',
  '1234 Test St, San Diego, CA',
  32.7157,
  -117.1611,
  4,
  'This is a test experience for manual testing',
  'text',
  now()
);
```

### DevTools Console Commands

```javascript
// Check current map position
console.log(window.location.search)

// Count markers on page
document.querySelectorAll('.custom-marker').length

// Check if modal is open
document.querySelector('[role="dialog"]') !== null
```
